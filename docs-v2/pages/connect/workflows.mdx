import { Steps, Tabs } from 'nextra/components'
import ArcadeEmbed from '@/components/ArcadeEmbed'
import Callout from '@/components/Callout'
import Image from 'next/image'

# Running workflows for your end users

Just like you can build and run internal [workflows](/workflows/) for your team, **you can run workflows for [your end users](/connect/api#external-users), too**.

Whether you're building well-defined integrations or more-autonomous AI agents, workflows provide a powerful set of tools for running [code](/code) or [pre-defined actions](/workflows/actions) on behalf of your users. Pipedream's UI makes it easy to build, test, and [debug](/workflows/inspect) workflows.

## What are workflows?

<div className="mt-4">
<img width="500px" src="https://res.cloudinary.com/pipedreamin/image/upload/v1730935490/docs/pCBdtm7Ca9CdPHTe76PwfzddY_qowz2v.avif" />
</div>

Workflows are sequences of [steps](/workflows/steps) [triggered by an event](/workflows/triggers), like an HTTP request, or new rows in a Google sheet.

You can use [pre-built actions](/workflows/actions/) or custom [Node.js](/code/nodejs/), [Python](/code/python/), [Golang](/code/go/), or [Bash](/code/bash/) code in workflows and connect to any of our {process.env.PUBLIC_APPS} integrated apps.

Workflows also have built-in:

- [Flow control](/workflows/control-flow)
- [Concurrency and throttling](/workflows/concurrency-and-throttling)
- [Key-value stores](/data-stores)
- [Error handling](/workflows/errors)
- [VPCs](/workflows/vpc)
- [And more](https://pipedream.com/pricing)

Read [the quickstart](/quickstart/) to learn more.

## How to run workflows for your end users

<Steps>

### Create an OAuth client

**This step is optional but strongly recommended.** To securely run workflows for end users, you'll need to first [create a Pipedream OAuth client](/rest-api/auth#creating-an-oauth-client). Pipedream uses OAuth to authenticate requests to the Pipedream API and workflows.


### Create a workflow

[Create a new workflow](/workflows#how-do-i-create-a-new-workflow) or open an existing one.

### Add an HTTP trigger, configure OAuth

1. Add an [HTTP trigger](/workflows/triggers#http) to your workflow.
2. [Configure **OAuth** authorization](/workflows/triggers#oauth) on the trigger. Again, this step is optional **but strongly recommended.**

### Configure accounts to use your end users' auth

When you configure [pre-built actions](/workflows/actions) or [custom code that connects to third-party APIs](/code/nodejs/auth), you can link accounts in one of two ways:

1. **Use your own account**: If you're connecting to an API that uses your own API key or developer account — for example, a workflow that connects to the OpenAI API or a PostgreSQL database — click the **Connect account** button to link your own, static account.

<div className="my-4">
<img width="300px" src="https://res.cloudinary.com/pipedreamin/image/upload/v1730936163/docs/Screenshot_2024-11-06_at_3.35.58_PM_a4evmq.png" />
</div>

2. **Use your end users' auth**: If you're building a workflow that connects to your end users' accounts — for example, a workflow that sends a message with your user's Slack account — you can select the option to **Use end user's auth via Connect**:

<div className="my-4">
<img width="300px" src="https://res.cloudinary.com/pipedreamin/image/upload/v1730936776/docs/Screenshot_2024-11-06_at_3.46.10_PM_mxjvla.png" />
</div>

When you trigger the workflow, Pipedream will look up the corresponding account for the end user whose user ID you provide [when invoking the workflow](#invoke-the-workflow).

### Connect a test account

To run an end-to-end test as an end user, you need to have users and connected accounts in your project. If you already have a **development** account linked, you can skip this step.

If you don't, the fastest way to do this is [on the **Users** tab](/connect#users) in your Pipedream project:
- You'll see there's a button to **Connect account**
- Go through the flow and make sure to create the account in **development** mode
- Note the **external user ID** of the account you just connected, you'll need it in the next step

<ArcadeEmbed
    src="https://demo.arcade.software/5DwriJYz5lIIRlXkVZEK?embed"
    title="Pipedream Connect Test Account Flow">
</ArcadeEmbed>

### Generate a test request

Test events are critical for developing workflows effectively. Without a test event, you won't be able to test your workflow end to end in the builder, see the shape of the event data that triggers the workflow, and the lookup to use your end user's auth won't work.

To generate a test event, click **Send Test Event** in the trigger, and fill in the event data. This will trigger the workflow and allow you to test the workflow end to end in the builder.

<Callout type="info">
Make sure to include these headers in your test request:
- `x-pd-environment: development`
- `x-pd-external-user-id: {your_external_user_id}`
</Callout>

<br />

<Image src="https://res.cloudinary.com/pipedreamin/image/upload/v1732236408/connect-headers-test-request_vrnpmv.png" alt="Invoke workflow headers" width={800} height={529} />

### Deploy your workflow

When you're done with the workflow, click **Deploy** at the top right.

### Invoke the workflow

If you're using TypeScript or a JavaScript runtime, [install the Pipedream SDK](/connect/api#installing-the-typescript-sdk). Pipedream also provides an HTTP API for invoking workflows (see example below).

```bash
npm i @pipedream/sdk
```

To invoke workflows, you'll need:

1. The OAuth client ID and secret from **[Step 1](/connect/workflows#create-an-oauth-client)**
2. Your [Project ID](/projects#finding-your-projects-id)
3. Your workflow's HTTP endpoint URL
4. The [external user ID](/connect/api#external-users) of the user you'd like to run the workflow for
5. The [Connect environment](/connect/environments) tied to the user's account

Then invoke the workflow like so:

<Tabs items={['TypeScript', 'Node.js', 'HTTP (cURL)']}>
<Tabs.Tab>
```typescript
import { createBackendClient, HTTPAuthType } from "@pipedream/sdk/server";
 
// These secrets should be saved securely and passed to your environment
const pd = createBackendClient({
  environment: "development", // change to production if running for a test production account, or in production
  credentials: {
    clientId: "{oauth_client_id}",
    clientSecret: "{oauth_client_secret}",
  },
  projectId: "{your_project_id}"
});

await pd.invokeWorkflowForExternalUser(
  "{your_endpoint_url}", // pass the endpoint ID or full URL here
  "{your_external_user_id}" // The end user's ID in your system
  {
    method: "POST",
    body: {
      message: "Hello World"
    }
  },
  HTTPAuthType.OAuth // Will automatically send the Authorization header with a fresh token
)
```
</Tabs.Tab>
<Tabs.Tab>
```javascript
import { createBackendClient } from "@pipedream/sdk/server";

// These secrets should be saved securely and passed to your environment
const client = createBackendClient({
  environment: "development", // change to production if running for a test production account, or in production
  credentials: {
    clientId: "{oauth_client_id}", 
    clientSecret: "{oauth_client_secret}"
  },
  projectId: "{your_project_id}"
});

const response = await client.invokeWorkflowForExternalUser(
  "{your_endpoint_url}", // pass the endpoint ID or full URL here
  "{your_external_user_id}" // The end user's ID in your system
  {
    method: "POST",
    body: {
      message: "Hello World"
    }
  }
)
```
</Tabs.Tab>
<Tabs.Tab>
```bash
# First, obtain an OAuth access token
curl -X POST https://api.pipedream.com/v1/oauth/token \
  -H "Content-Type: application/json" \
  -d '{
    "grant_type": "client_credentials",
    "client_id": "{oauth_client_id}",
    "client_secret": "{oauth_client_secret}"
  }'

# The response will include an access_token. Use it in the Authorization header below.

curl -X POST https://{your-endpoint-url} \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {access_token}" \
  -H 'X-PD-External-User-ID: {your_external_user_id}' \
  -H 'X-PD-Environment: development' \  # 'development' or 'production'
  -d '{
    "message": "Hello, world"
  }'
```
</Tabs.Tab>
</Tabs>
</Steps>

## Errors

#### No external user ID passed, but one or more steps require it
- One or more steps in the workflow are configured to **Use end user's auth via Connect**, but no external user ID was passed when invoking the workflow.
- [Refer to the docs](#invoke-the-workflow) to make sure you're passing external user ID correctly when invoking the workflow.

#### No matching external user ID 
- There was an external user ID passed, but it didn't match any users in the project.
- Double-check that the external user ID that you passed when invoking the workflow matches one either [in the UI](/connect#users) or [via the API](/connect/api#accounts).

#### Required account not found for external user ID
- The external user ID was passed when invoking the workflow, but the user doesn't have a connected account for one or more of the apps that are configured to use it in this workflow execution.
- You can check which connected accounts are available for that user [in the UI](/connect#users) or [via the API](/connect/api#accounts).

#### Running workflows for your users in production requires a higher tier plan
- Anyone is able to run workflows for your end users in `development`. The Business plan is required to run on behalf of `production` users.
- Schedule a call with our sales team and learn more about pricing [here](https://pipedream.com/pricing?plan=Enterprise).