import bookingExperts from "../../booking_experts.app.mjs";
import {
  LIMITERS_OPTIONS,
  SORTERS_OPTIONS,
  WEEKDAY_OPTIONS,
} from "../../common/constants.mjs";
import { parseObject } from "../../common/utils.mjs";

export default {
  key: "booking_experts-list-availabilities",
  name: "List Availabilities",
  description: "List availabilities of a channel you have access to. [See the documentation](https://developers.bookingexperts.com/reference/availabilities-index)",
  version: "0.0.6",
  annotations: {
    destructiveHint: false,
    openWorldHint: true,
    readOnlyHint: true,
  },
  type: "action",
  props: {
    bookingExperts,
    info: {
      type: "alert",
      alertType: "warning",
      content: "**You must have at least one channel created through the Booking Experts API.**",
    },
    fields: {
      type: "string[]",
      label: "Fields",
      description: "Fieldset of attributes to return. [See the documentation](https://developers.bookingexperts.com/reference/availabilities-index)",
      optional: true,
    },
    include: {
      type: "string[]",
      label: "Include",
      description: "Includes list of resources to include. [See the documentation](https://developers.bookingexperts.com/reference/availabilities-index)",
      optional: true,
    },
    channelIds: {
      propDefinition: [
        bookingExperts,
        "channelId",
      ],
      type: "string[]",
      label: "Channel IDs",
      description: "Specify a list of channel IDs to be used for searching availability. By default, all accessible channels associated to your app will be used. Overriding this may be useful when you have access to multiple channels of the same administration.",
      optional: true,
    },
    includeSemanticSegmentCounts: {
      type: "boolean",
      label: "Include Semantic Segment Counts",
      description: "When `true`, the amount of results per semantic segment will be added to the metadata",
      optional: true,
    },
    includeAmenityCounts: {
      type: "boolean",
      label: "Include Amenity Counts",
      description: "When `true`, the amount of results per amenity will be added to the metadata",
      optional: true,
    },
    referrer: {
      type: "string",
      label: "Referrer",
      description: "Referrer name.",
      optional: true,
    },
    startDate: {
      type: "string",
      label: "Start Date",
      description: "Filter on start date. Expects a date range. Note: date ranges have an exclusive end date. Format: `YYYY-MM-DD..YYYY-MM-DD`",
      optional: true,
    },
    overlapsDate: {
      type: "string",
      label: "Overlaps Date",
      description: "Filter availabilities that (partially) overlap these dates. Format: `YYYY-MM-DD..YYYY-MM-DD`",
      optional: true,
    },
    includesDate: {
      type: "string",
      label: "Includes Date",
      description: "Filter availabilities that contain the specified date range. Format: `YYYY-MM-DD..YYYY-MM-DD`",
      optional: true,
    },
    arrangement: {
      type: "string",
      label: "Arrangement",
      description: "Filter on availabilities that exactly match the supplied date range. Format: `YYYY-MM-DD..YYYY-MM-DD`",
      optional: true,
    },
    los: {
      type: "string",
      label: "Los",
      description: "Filter on length of stay. Format: `1..21`",
      optional: true,
    },
    wday: {
      type: "string",
      label: "Wday",
      description: "Filter on a particular week day",
      options: WEEKDAY_OPTIONS,
      optional: true,
    },
    administrationIds: {
      propDefinition: [
        bookingExperts,
        "administrationId",
      ],
      type: "string[]",
      label: "Administration IDs",
      description: "Filter on administrations",
      optional: true,
    },
    rentableTypeIds: {
      type: "string[]",
      label: "Rentable Type IDs",
      description: "Filter on rentable types",
      optional: true,
    },
    excludeRentableTypeIds: {
      type: "string[]",
      label: "Exclude Rentable Type IDs",
      description: "Exclude rentable types",
      optional: true,
    },
    rentableSegmentIds: {
      propDefinition: [
        bookingExperts,
        "rentableSegmentId",
      ],
      type: "string[]",
      label: "Rentable Segment IDs",
      description: "Filter on rentable segments.",
      optional: true,
    },
    excludeRentableSegmentIds: {
      propDefinition: [
        bookingExperts,
        "rentableSegmentId",
      ],
      type: "string[]",
      label: "Exclude Rentable Segment IDs",
      description: "Exclude rentable segments.",
      optional: true,
    },
    amenityIds: {
      propDefinition: [
        bookingExperts,
        "amenityId",
      ],
      type: "string[]",
      label: "Amenity IDs",
      description: "Filter on amenities.",
      optional: true,
    },
    discountCampaignId: {
      propDefinition: [
        bookingExperts,
        "discountCampaignId",
        (c) => ({
          administrationId: c.administrationId,
        }),
      ],
      description: "Filter on discount campaign ID.",
      optional: true,
    },
    inventoryObjectId: {
      propDefinition: [
        bookingExperts,
        "inventoryObjectId",
        (c) => ({
          administrationId: c.administrationId,
        }),
      ],
      description: "Filter on inventory object ID.",
      optional: true,
    },
    promotionToken: {
      type: "string",
      label: "Promotion Token",
      description: "Filter on owner promotion token.",
      optional: true,
    },
    countryCodes: {
      type: "string[]",
      label: "Country Codes",
      description: "Filter on country codes. Specify a comma separated list of ISO 3166-1 alpha-2 country codes. For example: NL,EN,DE.",
      optional: true,
    },
    excludeCountryCodes: {
      type: "string[]",
      label: "Exclude Country Codes",
      description: "Exclude country codes. Specify a comma separated list of ISO 3166-1 alpha-2 country codes. For example: NL,EN,DE.",
      optional: true,
    },
    seniors: {
      type: "integer",
      label: "Seniors",
      description: "Filter on number of seniors.",
      optional: true,
    },
    adults: {
      type: "integer",
      label: "Adults",
      description: "Filter on number of adults.",
      optional: true,
    },
    adolescents: {
      type: "integer",
      label: "Adolescents",
      description: "Filter on number of adolescents.",
      optional: true,
    },
    children: {
      type: "integer",
      label: "Children",
      description: "Filter on number of children.",
      optional: true,
    },
    babies: {
      type: "integer",
      label: "Babies",
      description: "Filter on number of babies.",
      optional: true,
    },
    pets: {
      type: "integer",
      label: "Pets",
      description: "Filter on number of pets.",
      optional: true,
    },
    price: {
      type: "string",
      label: "Price",
      description: "Filter on a price range. Format: `100..200`",
      optional: true,
    },
    currency: {
      type: "string",
      label: "Currency",
      description: "Filter on a specific ISO 4217 currency code. By default the prices are returned in the administration's native currency. Results can differ per currency",
      optional: true,
    },
    numberOfBedrooms: {
      type: "integer",
      label: "Number of Bedrooms",
      description: "Filter on type number of bedrooms.",
      optional: true,
    },
    numberOfBeds: {
      type: "integer",
      label: "Number of Beds",
      description: "Filter on type number of beds.",
      optional: true,
    },
    numberOfShowers: {
      type: "integer",
      label: "Number of Showers",
      description: "Filter on type number of showers.",
      optional: true,
    },
    numberOfToilets: {
      type: "integer",
      label: "Number of Toilets",
      description: "Filter on type number of toilets.",
      optional: true,
    },
    numberOfBathrooms: {
      type: "integer",
      label: "Number of Bathrooms",
      description: "Filter on type number of bathrooms.",
      optional: true,
    },
    numberOfParkingSpots: {
      type: "integer",
      label: "Number of Parking Spots",
      description: "Filter on type number of parking spots.",
      optional: true,
    },
    numberOfChildBeds: {
      type: "integer",
      label: "Number of Child Beds",
      description: "Filter on type number of beds.",
      optional: true,
    },
    numberOfChildChairs: {
      type: "integer",
      label: "Number of Child Chairs",
      description: "Filter on type number of child chairs.",
      optional: true,
    },
    sorters: {
      type: "string[]",
      label: "Sorters",
      description: "Specify a comma separated list of sorters to apply",
      options: SORTERS_OPTIONS,
      optional: true,
    },
    losDesc: {
      type: "boolean",
      label: "Los Desc",
      description: "Boolean specifying the sort direction for the `los` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    losDistanceDesc: {
      type: "boolean",
      label: "Los Distance Desc",
      description: "Boolean specifying the sort direction for the `los_distance` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    losDistanceLos: {
      type: "integer",
      label: "Los Distance Los",
      description: "Length of stay for the `los_distance` sorter.",
      optional: true,
    },
    startDateDesc: {
      type: "boolean",
      label: "Start Date Desc",
      description: "Boolean specifying the sort direction for the `start_date` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    startDateDistanceDesc: {
      type: "boolean",
      label: "Start Date Distance Desc",
      description: "Boolean specifying the sort direction for the `start_date_distance` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    startDateDistanceStartDate: {
      type: "string",
      label: "Start Date Distance Start Date",
      description: "Start date for the `start_date_distance` sorter. Format: `YYYY-MM-DD`",
      optional: true,
    },
    arrangementDistanceDesc: {
      type: "boolean",
      label: "Arrangement Distance Desc",
      description: "Boolean specifying the sort direction for the `arrangement_distance` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    arrangementDistanceArrangement: {
      type: "string",
      label: "Arrangement Distance Arrangement",
      description: "Arrangement for the `arrangement_distance` sorter. Format: `YYYY-MM-DD..YYYY-MM-DD`",
      optional: true,
    },
    maxGuestsDesc: {
      type: "boolean",
      label: "Max Guests Desc",
      description: "Boolean specifying the sort direction for the `max_guests` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    highlightedDesc: {
      type: "boolean",
      label: "Highlighted Desc",
      description: "Boolean specifying the sort direction for the `highlighted` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    allInAmountDesc: {
      type: "boolean",
      label: "All In Amount Desc",
      description: "Boolean specifying the sort direction for the `all_in_amount` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    amenityIdsMatchScoreDesc: {
      type: "boolean",
      label: "Amenity Ids Match Score Desc",
      description: "Boolean specifying the sort direction for the `amenity_ids_match_score` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    amenityIdsMatchScoreAmenityIds: {
      type: "string[]",
      label: "Amenity Ids Match Score Amenity Ids",
      description: "Amenity IDs for the `amenity_ids_match_score` sorter.",
      optional: true,
    },
    avgScoreDesc: {
      type: "boolean",
      label: "Avg Score Desc",
      description: "Boolean specifying the sort direction for the `avg_score` sorter. When unspecified, ascending order is implied.",
      optional: true,
    },
    limit: {
      type: "string",
      label: "Limit",
      description: "Specify a limiter here.",
      options: LIMITERS_OPTIONS,
      optional: true,
    },
    availabilitiesLimit: {
      type: "integer",
      label: "Availabilities Limit",
      description: "Return `limit` availabilities.",
      optional: true,
    },
    startDatesLimit: {
      type: "integer",
      label: "Start Dates Limit",
      description: "Limit to the `limit` best arrival dates.",
      optional: true,
    },
    startDatesAvailabilities: {
      type: "integer",
      label: "Start Dates Availabilities",
      description: "Number of availabilities to return.",
      optional: true,
    },
    losLimit: {
      type: "integer",
      label: "Los Limit",
      description: "Limit to the `limit` best Length of stay (LOS) values.",
      optional: true,
    },
    losAvailabilities: {
      type: "integer",
      label: "Los Availabilities",
      description: "Number of availabilities to return.",
      optional: true,
    },
    categoriesOffset: {
      type: "integer",
      label: "Categories Offset",
      description: "Result offset for the `categories` limiter, useful for pagination.",
      optional: true,
    },
    categoriesAvailabilities: {
      type: "integer",
      label: "Categories Availabilities",
      description: "Number of availabilities to return.",
      optional: true,
    },
    rentableTypesLimit: {
      type: "integer",
      label: "Rentable Types Limit",
      description: "Limit to the `limit` best types.",
      optional: true,
    },
    rentableTypesOffset: {
      type: "integer",
      label: "Rentable Types Offset",
      description: "Result offset for the `rentable_types` limiter, useful for pagination.",
      optional: true,
    },
    rentableTypesAvailabilities: {
      type: "integer",
      label: "Rentable Types Availabilities",
      description: "Number of availabilities to return.",
      optional: true,
    },
    administrationsLimit: {
      type: "integer",
      label: "Administrations Limit",
      description: "Limit to the `limit` best administrations.",
      optional: true,
    },
    administrationsRentableTypes: {
      type: "integer",
      label: "Administrations Rentable Types",
      description: "Limit to the `limit` best types.",
      optional: true,
    },
    administrationsAvailabilities: {
      type: "integer",
      label: "Administrations Availabilities",
      description: "Number of availabilities to return.",
      optional: true,
    },
  },
  async run({ $ }) {
    const { data } = await this.bookingExperts.listAvailabilities({
      $,
      params: {
        "fields[availability]": parseObject(this.fields)?.join(","),
        "include": parseObject(this.include)?.join(","),
        "channelIds": parseObject(this.channelIds)?.join(","),
        "include_semantic_segment_counts": this.includeSemanticSegmentCounts,
        "include_amenity_counts": this.includeAmenityCounts,
        "referrer": this.referrer,
        "filter[start_date]": this.startDate,
        "filter[overlaps_date]": this.overlapsDate,
        "filter[includes_date]": this.includesDate,
        "filter[arrangement]": this.arrangement,
        "filter[los]": this.los,
        "filter[wday]": this.wday
          ? parseInt(this.wday)
          : undefined,
        "filter[administration_ids]": parseObject(this.administrationIds)?.join(","),
        "filter[rentable_type_ids]": parseObject(this.rentableTypeIds)?.join(","),
        "filter[-rentable_type_ids]": parseObject(this.excludeRentableTypeIds)?.join(","),
        "filter[rentable_segment_ids]": parseObject(this.rentableSegmentIds)?.join(","),
        "filter[-rentable_segment_ids]": parseObject(this.excludeRentableSegmentIds)?.join(","),
        "filter[amenity_ids]": parseObject(this.amenityIds)?.join(","),
        "filter[discount_campaign_id]": this.discountCampaignId,
        "filter[inventory_object_id]": this.inventoryObjectId,
        "filter[promotion_token]": this.promotionToken,
        "filter[country_codes]": parseObject(this.countryCodes)?.join(","),
        "filter[-country_codes]": parseObject(this.excludeCountryCodes)?.join(","),
        "filter[guest_group][seniors]": this.seniors,
        "filter[guest_group][adults]": this.adults,
        "filter[guest_group][adolescents]": this.adolescents,
        "filter[guest_group][children]": this.children,
        "filter[guest_group][babies]": this.babies,
        "filter[guest_group][pets]": this.pets,
        "filter[price]": this.price,
        "filter[currency]": this.currency,
        "filter[number_of_bedrooms]": this.numberOfBedrooms,
        "filter[number_of_beds]": this.numberOfBeds,
        "filter[number_of_showers]": this.numberOfShowers,
        "filter[number_of_toilets]": this.numberOfToilets,
        "filter[number_of_bathrooms]": this.numberOfBathrooms,
        "filter[number_of_parking_spots]": this.numberOfParkingSpots,
        "filter[number_of_child_beds]": this.numberOfChildBeds,
        "filter[number_of_child_chairs]": this.numberOfChildChairs,
        "sorters": parseObject(this.sorters)?.join(","),
        "sorter[los][desc]": this.losDesc,
        "sorter[los_distance][desc]": this.losDistanceDesc,
        "sorter[los_distance][los]": this.losDistanceLos,
        "sorter[start_date][desc]": this.startDateDesc,
        "sorter[start_date_distance][desc]": this.startDateDistanceDesc,
        "sorter[start_date_distance][start_date]": this.startDateDistanceStartDate,
        "sorter[arrangement_distance][desc]": this.arrangementDistanceDesc,
        "sorter[arrangement_distance][arrangement]": this.arrangementDistanceArrangement,
        "sorter[max_guests][desc]": this.maxGuestsDesc,
        "sorter[highlighted][desc]": this.highlightedDesc,
        "sorter[all_in_amount][desc]": this.allInAmountDesc,
        "sorter[amenity_ids_match_score][desc]": this.amenityIdsMatchScoreDesc,
        "sorter[amenity_ids_match_score][amenity_ids]": parseObject(this.amenityIdsMatchScoreAmenityIds)?.join(","),
        "sorter[avg_score][desc]": this.avgScoreDesc,
        "limit": this.limit,
        "limiter[availabilities][limit]": this.availabilitiesLimit,
        "limiter[start_dates][limit]": this.startDatesLimit,
        "limiter[start_dates][availabilities]": this.startDatesAvailabilities,
        "limiter[los][limit]": this.losLimit,
        "limiter[los][availabilities]": this.losAvailabilities,
        "limiter[categories][offset]": this.categoriesOffset,
        "limiter[categories][availabilities]": this.categoriesAvailabilities,
        "limiter[rentable_types][limit]": this.rentableTypesLimit,
        "limiter[rentable_types][offset]": this.rentableTypesOffset,
        "limiter[rentable_types][availabilities]": this.rentableTypesAvailabilities,
        "limiter[administrations][limit]": this.administrationsLimit,
        "limiter[administrations][rentable_types]": this.administrationsRentableTypes,
        "limiter[administrations][availabilities]": this.administrationsAvailabilities,
      },
    });
    $.export("$summary", `Found ${data.length} availabilities`);
    return data;
  },
};
